/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.2
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 * 2015
 * Fork by Orakaro
 * Disable cursor movement (insertAfter mad insertBefore)
 */
!function($){function coerceToString(val){return String(null===val||void 0===val?"":val)}function _escapeHTML(text){return coerceToString(text).replace(HTML_ESCAPE_CHARS,function(match){return HTML_ESCAPES[match]})}var DEFAULT_SETTINGS={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",excludeCurrent:!1,excludeCurrentParameter:"x",prePopulate:null,processPrePopulate:!1,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&#215;",animateDropdown:!0,placeholder:null,theme:null,zindex:999,resultsLimit:null,enableHTML:!1,resultsFormatter:function(item){var string=item[this.propertyToSearch];return"<li>"+(this.enableHTML?string:_escapeHTML(string))+"</li>"},tokenFormatter:function(item){var string=item[this.propertyToSearch];return"<li><p>"+(this.enableHTML?string:_escapeHTML(string))+"</p></li>"},tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",allowFreeTagging:!1,allowTabOut:!1,autoSelectFirstResult:!1,onResult:null,onCachedResult:null,onAdd:null,onFreeTaggingAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-",disabled:!1},DEFAULT_CLASSES={tokenList:"token-input-list",token:"token-input-token",tokenReadOnly:"token-input-token-readonly",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token",focused:"token-input-focused",disabled:"token-input-disabled"},POSITION={BEFORE:0,AFTER:1,END:2},KEY={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},HTML_ESCAPES={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"},HTML_ESCAPE_CHARS=/[&<>"'\/]/g,LAST_RESULT={},methods={init:function(url_or_data_or_function,options){var settings=$.extend({},DEFAULT_SETTINGS,options||{});return this.each(function(){$(this).data("settings",settings),$(this).data("tokenInputObject",new $.TokenList(this,url_or_data_or_function,settings))})},clear:function(){return this.data("tokenInputObject").clear(),this},add:function(item){return this.data("tokenInputObject").add(item),this},remove:function(item){return this.data("tokenInputObject").remove(item),this},get:function(){return this.data("tokenInputObject").getTokens()},toggleDisabled:function(disable){return this.data("tokenInputObject").toggleDisabled(disable),this},setOptions:function(options){return $(this).data("settings",$.extend({},$(this).data("settings"),options||{})),this},destroy:function(){if(this.data("tokenInputObject")){this.data("tokenInputObject").clear();var tmpInput=this,closest=this.parent();return closest.empty(),tmpInput.show(),closest.append(tmpInput),tmpInput}}};$.fn.tokenInput=function(method){return methods[method]?methods[method].apply(this,Array.prototype.slice.call(arguments,1)):methods.init.apply(this,arguments)},$.TokenList=function(input,url_or_data,settings){function escapeHTML(text){return $(input).data("settings").enableHTML?text:_escapeHTML(text)}function toggleDisabled(disable){$(input).data("settings").disabled="boolean"==typeof disable?disable:!$(input).data("settings").disabled,input_box.attr("disabled",$(input).data("settings").disabled),token_list.toggleClass($(input).data("settings").classes.disabled,$(input).data("settings").disabled),selected_token&&deselect_token($(selected_token),POSITION.END),hiddenInput.attr("disabled",$(input).data("settings").disabled)}function checkTokenLimit(){return null!==$(input).data("settings").tokenLimit&&token_count>=$(input).data("settings").tokenLimit?(input_box.hide(),void hide_dropdown()):void 0}function resize_input(){if(input_val!==(input_val=input_box.val())){var width_left=token_list.width()-input_box.offset().left-token_list.offset().left;input_resizer.html(_escapeHTML(input_val)||_escapeHTML(settings.placeholder)),input_box.width(Math.min(token_list.width(),Math.max(width_left,input_resizer.width()+30)))}}function add_freetagging_tokens(){var value=$.trim(input_box.val()),tokens=value.split($(input).data("settings").tokenDelimiter);$.each(tokens,function(i,token){if(token){$.isFunction($(input).data("settings").onFreeTaggingAdd)&&(token=$(input).data("settings").onFreeTaggingAdd.call(hiddenInput,token));var object={};object[$(input).data("settings").tokenValue]=object[$(input).data("settings").propertyToSearch]=token;var existingCount=0;$.each(excludeCurrent(LAST_RESULT),function(index,value){token==value[$(input).data("settings").tokenValue]&&(existingCount=value.count)}),object.count=existingCount,add_token(object)}})}function insert_token(item){var $this_token=$($(input).data("settings").tokenFormatter(item)),readonly=item.readonly===!0;readonly&&$this_token.addClass($(input).data("settings").classes.tokenReadOnly),$this_token.addClass($(input).data("settings").classes.token).insertBefore(input_token),readonly||$("<span>"+$(input).data("settings").deleteText+"</span>").addClass($(input).data("settings").classes.tokenDelete).appendTo($this_token).click(function(){return $(input).data("settings").disabled?void 0:(delete_token($(this).parent()),hiddenInput.change(),!1)});var token_data=item;return $.data($this_token.get(0),"tokeninput",item),saved_tokens=saved_tokens.slice(0,selected_token_index).concat([token_data]).concat(saved_tokens.slice(selected_token_index)),selected_token_index++,update_hiddenInput(saved_tokens,hiddenInput),token_count+=1,null!==$(input).data("settings").tokenLimit&&token_count>=$(input).data("settings").tokenLimit&&(input_box.hide(),hide_dropdown()),$this_token}function add_token(item){var callback=$(input).data("settings").onAdd;if(token_count>0&&$(input).data("settings").preventDuplicates){var found_existing_token=null;if(token_list.children().each(function(){var existing_token=$(this),existing_data=$.data(existing_token.get(0),"tokeninput");return existing_data&&existing_data[settings.tokenValue]===item[settings.tokenValue]?(found_existing_token=existing_token,!1):void 0}),found_existing_token)return select_token(found_existing_token),void focusWithTimeout(input_box)}input_box.width(1),(null==$(input).data("settings").tokenLimit||token_count<$(input).data("settings").tokenLimit)&&(insert_token(item),input_box.attr("placeholder",null),checkTokenLimit()),input_box.val(""),hide_dropdown(),$.isFunction(callback)&&callback.call(hiddenInput,item)}function select_token(token){$(input).data("settings").disabled||(token.addClass($(input).data("settings").classes.selectedToken),selected_token=token.get(0),input_box.val(""),hide_dropdown())}function deselect_token(token,position){token.removeClass($(input).data("settings").classes.selectedToken),selected_token=null,position===POSITION.BEFORE?selected_token_index--:position===POSITION.AFTER?selected_token_index++:(input_token.appendTo(token_list),selected_token_index=token_count),focusWithTimeout(input_box)}function toggle_select_token(token){var previous_selected_token=selected_token;selected_token&&deselect_token($(selected_token),POSITION.END),previous_selected_token===token.get(0)?deselect_token(token,POSITION.END):select_token(token)}function delete_token(token){var token_data=$.data(token.get(0),"tokeninput"),callback=$(input).data("settings").onDelete,index=token.prevAll().length;index>selected_token_index&&index--,token.remove(),selected_token=null,focusWithTimeout(input_box),saved_tokens=saved_tokens.slice(0,index).concat(saved_tokens.slice(index+1)),0==saved_tokens.length&&input_box.attr("placeholder",settings.placeholder),selected_token_index>index&&selected_token_index--,update_hiddenInput(saved_tokens,hiddenInput),token_count-=1,null!==$(input).data("settings").tokenLimit&&(input_box.show().val(""),focusWithTimeout(input_box)),$.isFunction(callback)&&callback.call(hiddenInput,token_data)}function update_hiddenInput(saved_tokens,hiddenInput){var token_values=$.map(saved_tokens,function(el){return"function"==typeof $(input).data("settings").tokenValue?$(input).data("settings").tokenValue.call(this,el):el[$(input).data("settings").tokenValue]});hiddenInput.val(token_values.join($(input).data("settings").tokenDelimiter))}function hide_dropdown(){dropdown.hide().empty(),selected_dropdown_item=null}function show_dropdown(){dropdown.css({position:"absolute",top:token_list.offset().top+token_list.outerHeight(!0),left:token_list.offset().left,width:token_list.width(),"z-index":$(input).data("settings").zindex}).show()}function show_dropdown_searching(){$(input).data("settings").searchingText&&(dropdown.html("<p>"+escapeHTML($(input).data("settings").searchingText)+"</p>"),show_dropdown())}function show_dropdown_hint(){$(input).data("settings").hintText&&(dropdown.html("<p>"+escapeHTML($(input).data("settings").hintText)+"</p>"),show_dropdown())}function regexp_escape(term){return term.replace(regexp_special_chars,"\\$&")}function highlight_term(value,term){return value.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+regexp_escape(term)+")(?![^<>]*>)(?![^&;]+;)","gi"),function(match,p1){return"<b>"+escapeHTML(p1)+"</b>"})}function find_value_and_highlight_term(template,value,term){return template.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+regexp_escape(value)+")(?![^<>]*>)(?![^&;]+;)","g"),highlight_term(value,term))}function excludeCurrent(results){if($(input).data("settings").excludeCurrent){var currentTokens=$(input).data("tokenInputObject").getTokens(),trimmedList=[];currentTokens.length&&($.each(results,function(index,value){var notFound=!0;$.each(currentTokens,function(cIndex,cValue){return value[$(input).data("settings").propertyToSearch]==cValue[$(input).data("settings").propertyToSearch]?(notFound=!1,!1):void 0}),notFound&&trimmedList.push(value)}),results=trimmedList)}return results}function populateDropdown(query,results){if(results=excludeCurrent(results),results&&results.length){dropdown.empty();var dropdown_ul=$("<ul/>").appendTo(dropdown).mouseover(function(event){select_dropdown_item($(event.target).closest("li"))}).mousedown(function(event){return add_token($(event.target).closest("li").data("tokeninput")),hiddenInput.change(),!1}).hide();$(input).data("settings").resultsLimit&&results.length>$(input).data("settings").resultsLimit&&(results=results.slice(0,$(input).data("settings").resultsLimit)),$.each(results,function(index,value){var this_li=$(input).data("settings").resultsFormatter(value);this_li=find_value_and_highlight_term(this_li,value[$(input).data("settings").propertyToSearch],query),this_li=$(this_li).appendTo(dropdown_ul),this_li.addClass(index%2?$(input).data("settings").classes.dropdownItem:$(input).data("settings").classes.dropdownItem2),0===index&&$(input).data("settings").autoSelectFirstResult&&select_dropdown_item(this_li),$.data(this_li.get(0),"tokeninput",value)}),show_dropdown(),$(input).data("settings").animateDropdown?dropdown_ul.slideDown("fast"):dropdown_ul.show()}else $(input).data("settings").noResultsText&&(dropdown.html("<p>"+escapeHTML($(input).data("settings").noResultsText)+"</p>"),show_dropdown())}function select_dropdown_item(item){item&&(selected_dropdown_item&&deselect_dropdown_item($(selected_dropdown_item)),item.addClass($(input).data("settings").classes.selectedDropdownItem),selected_dropdown_item=item.get(0))}function deselect_dropdown_item(item){item.removeClass($(input).data("settings").classes.selectedDropdownItem),selected_dropdown_item=null}function do_search(){var query=input_box.val();query&&query.length&&(selected_token&&deselect_token($(selected_token),POSITION.AFTER),query.length>=$(input).data("settings").minChars?(show_dropdown_searching(),clearTimeout(timeout),timeout=setTimeout(function(){run_search(query)},$(input).data("settings").searchDelay)):hide_dropdown())}function run_search(query){var cache_key=query+computeURL(),cached_results=cache.get(cache_key);if(cached_results)$.isFunction($(input).data("settings").onCachedResult)&&(cached_results=$(input).data("settings").onCachedResult.call(hiddenInput,cached_results)),LAST_RESULT=cached_results,populateDropdown(query,LAST_RESULT);else if($(input).data("settings").url){var url=computeURL(),ajax_params={};if(ajax_params.data={},url.indexOf("?")>-1){var parts=url.split("?");ajax_params.url=parts[0];var param_array=parts[1].split("&");$.each(param_array,function(index,value){var kv=value.split("=");ajax_params.data[kv[0]]=kv[1]})}else ajax_params.url=url;if(ajax_params.data[$(input).data("settings").queryParam]=query,ajax_params.type=$(input).data("settings").method,ajax_params.dataType=$(input).data("settings").contentType,$(input).data("settings").crossDomain&&(ajax_params.dataType="jsonp"),$(input).data("settings").excludeCurrent){var currentTokens=$(input).data("tokenInputObject").getTokens(),tokenList=$.map(currentTokens,function(el){return"function"==typeof $(input).data("settings").tokenValue?$(input).data("settings").tokenValue.call(this,el):el[$(input).data("settings").tokenValue]});ajax_params.data[$(input).data("settings").excludeCurrentParameter]=tokenList.join($(input).data("settings").tokenDelimiter)}ajax_params.success=function(results){cache.add(cache_key,$(input).data("settings").jsonContainer?results[$(input).data("settings").jsonContainer]:results),$.isFunction($(input).data("settings").onResult)&&(results=$(input).data("settings").onResult.call(hiddenInput,results)),input_box.val()===query&&(LAST_RESULT=$(input).data("settings").jsonContainer?results[$(input).data("settings").jsonContainer]:results,populateDropdown(query,LAST_RESULT))},settings.onSend&&settings.onSend(ajax_params),$.ajax(ajax_params)}else if($(input).data("settings").local_data){var results=$.grep($(input).data("settings").local_data,function(row){return row[$(input).data("settings").propertyToSearch].toLowerCase().indexOf(query.toLowerCase())>-1});cache.add(cache_key,results),$.isFunction($(input).data("settings").onResult)&&(results=$(input).data("settings").onResult.call(hiddenInput,results)),LAST_RESULT=results,populateDropdown(query,LAST_RESULT)}}function computeURL(){var settings=$(input).data("settings");return"function"==typeof settings.url?settings.url.call(settings):settings.url}function focusWithTimeout(object){setTimeout(function(){object.focus()},50)}if("string"==typeof url_or_data||"function"==typeof url_or_data){$(input).data("settings").url=url_or_data;var url=computeURL();void 0===$(input).data("settings").crossDomain&&"string"==typeof url&&($(input).data("settings").crossDomain=-1===url.indexOf("://")?!1:location.href.split(/\/+/g)[1]!==url.split(/\/+/g)[1])}else"object"==typeof url_or_data&&($(input).data("settings").local_data=url_or_data);$(input).data("settings").classes?$(input).data("settings").classes=$.extend({},DEFAULT_CLASSES,$(input).data("settings").classes):$(input).data("settings").theme?($(input).data("settings").classes={},$.each(DEFAULT_CLASSES,function(key,value){$(input).data("settings").classes[key]=value+"-"+$(input).data("settings").theme})):$(input).data("settings").classes=DEFAULT_CLASSES;var timeout,input_val,saved_tokens=[],token_count=0,cache=new $.TokenList.Cache,input_box=$('<input type="text" autocomplete="off" autocapitalize="off"/>').css({outline:"none"}).attr("id",$(input).data("settings").idPrefix+input.id).focus(function(){return $(input).data("settings").disabled?!1:((null===$(input).data("settings").tokenLimit||$(input).data("settings").tokenLimit!==token_count)&&show_dropdown_hint(),void token_list.addClass($(input).data("settings").classes.focused))}).blur(function(){hide_dropdown(),$(input).data("settings").allowFreeTagging&&add_freetagging_tokens(),$(this).val(""),token_list.removeClass($(input).data("settings").classes.focused)}).bind("keyup keydown blur update",resize_input).keydown(function(event){var previous_token,next_token;switch(event.keyCode){case KEY.LEFT:case KEY.RIGHT:case KEY.UP:case KEY.DOWN:if(0===this.value.length)previous_token=input_token.prev(),next_token=input_token.next(),previous_token.length&&previous_token.get(0)===selected_token||next_token.length&&next_token.get(0)===selected_token?event.keyCode===KEY.LEFT||event.keyCode===KEY.UP?deselect_token($(selected_token),POSITION.BEFORE):deselect_token($(selected_token),POSITION.AFTER):event.keyCode!==KEY.LEFT&&event.keyCode!==KEY.UP||!previous_token.length?event.keyCode!==KEY.RIGHT&&event.keyCode!==KEY.DOWN||!next_token.length||select_token($(next_token.get(0))):select_token($(previous_token.get(0)));else{var dropdown_item=null;event.keyCode===KEY.DOWN||event.keyCode===KEY.RIGHT?(dropdown_item=$(dropdown).find("li").first(),selected_dropdown_item&&(dropdown_item=$(selected_dropdown_item).next())):(dropdown_item=$(dropdown).find("li").last(),selected_dropdown_item&&(dropdown_item=$(selected_dropdown_item).prev())),select_dropdown_item(dropdown_item)}break;case KEY.BACKSPACE:if(previous_token=input_token.prev(),0===this.value.length)return selected_token?(delete_token($(selected_token)),hiddenInput.change()):previous_token.length&&select_token($(previous_token.get(0))),!1;1===$(this).val().length?hide_dropdown():setTimeout(function(){do_search()},5);break;case KEY.TAB:case KEY.ENTER:case KEY.NUMPAD_ENTER:case KEY.COMMA:if(selected_dropdown_item)add_token($(selected_dropdown_item).data("tokeninput")),hiddenInput.change();else{if($(input).data("settings").allowFreeTagging){if($(input).data("settings").allowTabOut&&""===$(this).val())return!0;add_freetagging_tokens()}else if($(this).val(""),$(input).data("settings").allowTabOut)return!0;event.stopPropagation(),event.preventDefault()}return!1;case KEY.ESCAPE:return hide_dropdown(),!0;default:String.fromCharCode(event.which)&&setTimeout(function(){do_search()},5)}});settings.placeholder&&input_box.attr("placeholder",settings.placeholder);var hiddenInput=$(input).hide().val("").focus(function(){focusWithTimeout(input_box)}).blur(function(){return input_box.blur(),hiddenInput}),selected_token=null,selected_token_index=0,selected_dropdown_item=null,token_list=$("<ul />").addClass($(input).data("settings").classes.tokenList).click(function(event){var li=$(event.target).closest("li");li&&li.get(0)&&$.data(li.get(0),"tokeninput")?toggle_select_token(li):(selected_token&&deselect_token($(selected_token),POSITION.END),focusWithTimeout(input_box))}).mouseover(function(event){var li=$(event.target).closest("li");li&&selected_token!==this&&li.addClass($(input).data("settings").classes.highlightedToken)}).mouseout(function(event){var li=$(event.target).closest("li");li&&selected_token!==this&&li.removeClass($(input).data("settings").classes.highlightedToken)}).insertBefore(hiddenInput),input_token=$("<li />").addClass($(input).data("settings").classes.inputToken).appendTo(token_list).append(input_box),dropdown=$("<div/>").addClass($(input).data("settings").classes.dropdown).appendTo("body").hide(),input_resizer=$("<tester/>").insertAfter(input_box).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:input_box.css("fontSize"),fontFamily:input_box.css("fontFamily"),fontWeight:input_box.css("fontWeight"),letterSpacing:input_box.css("letterSpacing"),whiteSpace:"nowrap"});hiddenInput.val("");var li_data=$(input).data("settings").prePopulate||hiddenInput.data("pre");$(input).data("settings").processPrePopulate&&$.isFunction($(input).data("settings").onResult)&&(li_data=$(input).data("settings").onResult.call(hiddenInput,li_data)),li_data&&li_data.length&&$.each(li_data,function(index,value){insert_token(value),checkTokenLimit(),input_box.attr("placeholder",null)}),$(input).data("settings").disabled&&toggleDisabled(!0),"function"==typeof $(input).data("settings").onReady&&$(input).data("settings").onReady.call(),this.clear=function(){token_list.children("li").each(function(){0===$(this).children("input").length&&delete_token($(this))})},this.add=function(item){add_token(item)},this.remove=function(item){token_list.children("li").each(function(){if(0===$(this).children("input").length){var currToken=$(this).data("tokeninput"),match=!0;for(var prop in item)if(item[prop]!==currToken[prop]){match=!1;break}match&&delete_token($(this))}})},this.getTokens=function(){return saved_tokens},this.toggleDisabled=function(disable){toggleDisabled(disable)},resize_input();var regexp_special_chars=new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\-]","g")},$.TokenList.Cache=function(options){var settings,flush,data={},size=0;settings=$.extend({max_size:500},options),flush=function(){data={},size=0},this.add=function(query,results){size>settings.max_size&&flush(),data[query]||(size+=1),data[query]=results},this.get=function(query){return data[query]}}}(jQuery);